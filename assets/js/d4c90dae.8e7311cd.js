"use strict";(self.webpackChunkespresso=self.webpackChunkespresso||[]).push([["3183"],{8643:function(e,n,t){t.r(n),t.d(n,{frontMatter:()=>c,toc:()=>p,default:()=>u,metadata:()=>s,assets:()=>r,contentTitle:()=>l});var s=JSON.parse('{"id":"hands-on/convergence","title":"Convergence testing","description":"Convergence with cutoff energy using PWTK","source":"@site/docs/hands-on/convergence.mdx","sourceDirName":"hands-on","slug":"/hands-on/convergence","permalink":"/espresso/hands-on/convergence","draft":false,"unlisted":false,"editUrl":"https://github.com/pranabdas/espresso/blob/main/docs/hands-on/convergence.mdx","tags":[],"version":"current","frontMatter":{"title":"Convergence testing"},"sidebar":"docs","previous":{"title":"SCF calculation","permalink":"/espresso/hands-on/scf"},"next":{"title":"Structure optimization","permalink":"/espresso/hands-on/structure-optimization"}}'),i=t(5893),o=t(65),a=t(2834);let c={title:"Convergence testing"},l=void 0,r={},p=[{value:"Convergence with cutoff energy using PWTK",id:"convergence-with-cutoff-energy-using-pwtk",level:2},{value:"Convergence test using UNIX shell script",id:"convergence-test-using-unix-shell-script",level:2},{value:"Convergence test against the number of k-points",id:"convergence-test-against-the-number-of-k-points",level:2},{value:"Convergence against lattice constant",id:"convergence-against-lattice-constant",level:2},{value:"Note on CPU time",id:"note-on-cpu-time",level:2}];function h(e){let n={admonition:"admonition",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"convergence-with-cutoff-energy-using-pwtk",children:"Convergence with cutoff energy using PWTK"}),"\n",(0,i.jsxs)(n.p,{children:["We can automate the previous self consistent calculation by varying a certain\nparameter. Say we want to check the total energy of the system for various\nvalues of ",(0,i.jsx)(n.code,{children:"ecutwfc"}),". We can do that by using ",(0,i.jsx)(n.code,{children:"pwtk"})," script."]}),"\n","\n",(0,i.jsx)(a.Z,{language:"bash",title:"src/silicon/si_scf_ecutoff.pwtk",showLineNumbers:!0,children:'# load the pw.x input from file\nload_fromPWI pw.scf.silicon.in\n\n# open a file for writing resulting total energies\nset fid [open etot_vs_ecutwfc.dat w]\n\n# loop over different "ecut" values\nforeach ecut { 12 16 20 24 28 32 } {\n\n    # name of I/O files: $name.in & $name.out\n    set name si_scf_ecutwfc-$ecut\n\n    # set the pw.x "ecutwfc" variable\n    SYSTEM "ecutwfc = $ecut"\n\n    # run the pw.x calculation\n    runPW $name.in\n\n    # extract the "total energy" and write it to file\n    set Etot [::pwtk::pwo::totene $name.out]\n    puts $fid "$ecut $Etot"\n}\n\nclose $fid\n'}),"\n",(0,i.jsx)(n.p,{children:"To run the above script:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"pwtk si_scf_ecutoff.pwtk\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Now we can plot the total energy with respect to ecutwfc. The data is in\n",(0,i.jsx)(n.code,{children:"etot-vs-ecutwfc.dat"})]}),"\n",(0,i.jsx)(n.p,{children:"We will use matplotlib to make the plots. Here is the python code for plotting:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",metastring:'title="notebooks/silicon-scf.ipynb" showLineNumbers',children:"import matplotlib.pyplot as plt\nfrom matplotlib import rcParamsDefault\nimport numpy as np\n%matplotlib inline\nplt.rcParams[\"figure.dpi\"]=150\nplt.rcParams[\"figure.facecolor\"]=\"white\"\n\nx, y = np.loadtxt('../src/silicon/etot-vs-ecutwfc.dat', delimiter=' ', unpack=True)\nplt.plot(x, y, \"o-\", markersize=5, label='Etot vs ecutwfc')\nplt.xlabel('ecutwfc (Ry)')\nplt.ylabel('Etot (Ry)')\nplt.legend(frameon=False)\nplt.show()\n"})}),"\n",(0,i.jsx)("img",{src:t(739).Z,class:"inv-hue-rot-180",alt:"etot-vs-ecutwfc"}),"\n",(0,i.jsx)(n.h2,{id:"convergence-test-using-unix-shell-script",children:"Convergence test using UNIX shell script"}),"\n",(0,i.jsx)(n.p,{children:"We can do the convergence test with various parameters. We can calculate the\ntotal energy of the system by varying various parameters. We will use the shell\nscript to automate the process with different cutoff energy values."}),"\n","\n",(0,i.jsx)(a.Z,{language:"bash",title:"src/silicon/si_script.sh",showLineNumbers:!0,children:"#!/bin/sh\nNAME=\"ecut\"\n\nfor CUTOFF in  10 15 20 25 30 35 40\ndo\ncat > ${NAME}_${CUTOFF}.in << EOF\n &control\n    calculation = 'scf',\n    prefix = 'silicon'\n    outdir = './tmp/'\n    pseudo_dir = './pseudos/'\n /\n &system\n    ibrav =  2,\n    celldm(1) = 10.0,\n    nat =  2,\n    ntyp = 1,\n    ecutwfc = $CUTOFF\n /\n &electrons\n    mixing_beta = 0.6\n /\n\nATOMIC_SPECIES\n Si 28.086  Si.pz-vbc.UPF\n\nATOMIC_POSITIONS (alat)\n Si 0.0 0.0 0.0\n Si 0.25 0.25 0.25\n\nK_POINTS (automatic)\n  6 6 6 1 1 1\nEOF\n\npw.x < ${NAME}_${CUTOFF}.in > ${NAME}_${CUTOFF}.out\necho ${NAME}_${CUTOFF}\ngrep ! ${NAME}_${CUTOFF}.out\n\ndone\n"}),"\n",(0,i.jsx)(n.p,{children:"Make sure the file has executable permission for the user:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"chmod 700 si_script.sh\n"})}),"\n",(0,i.jsx)(n.p,{children:"Run the script file:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"./si_script.sh\n# or\nsh si_script.sh\n"})}),"\n",(0,i.jsx)(n.p,{children:"We can plot the energy vs cutoff energy, and choose a reasonable value."}),"\n",(0,i.jsxs)(n.admonition,{type:"caution",children:[(0,i.jsx)(n.p,{children:"Initially, I had problem in running the script in macOS. The problem occurred\nbecause the script file format was set to DOS. The file format can be checked in\nfollowing way:"}),(0,i.jsxs)(n.p,{children:["Open the file in ",(0,i.jsx)(n.strong,{children:"vi"})," editor. ",(0,i.jsx)(n.code,{children:"vi si_script.sh"})," Now in ",(0,i.jsx)(n.strong,{children:"vi"})," editor command\nmode (ESC key), type ",(0,i.jsx)(n.code,{children:":set ff?"})," This would tell you the file format. Now to\nchange file format, use the  command ",(0,i.jsx)(n.code,{children:":set fileformat=unix"})]})]}),"\n",(0,i.jsx)(n.h2,{id:"convergence-test-against-the-number-of-k-points",children:"Convergence test against the number of k-points"}),"\n",(0,i.jsx)(n.p,{children:"We can run similar convergence test against another parameter, and choose the\nbest value of that particular parameter. Here we will try to calculate the\nnumber of k-points in the Monkhorst-Pack mesh."}),"\n","\n",(0,i.jsx)(a.Z,{language:"bash",title:"src/silicon/si_scf_kpoints.pwtk",showLineNumbers:!0,children:'load_fromPWI pw.scf.silicon.in\n\nset fid [open etot-vs-kpoint.dat w]\n\nforeach k { 2 4 6 8 } {\n\n    set name si_scf_kpoints-$k\n\n    K_POINTS automatic "$k $k $k 1 1 1"\n    runPW $name.in\n\n    set Etot [::pwtk::pwo::totene $name.out]\n    puts $fid "$k $Etot"\n}\n\nclose $fid\n'}),"\n",(0,i.jsx)(n.p,{children:"Run pwtk program:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"pwtk si_scf_kpoints.pwtk\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",metastring:'title="notebooks/silicon-scf.ipynb" showLineNumbers',children:"x, y = np.loadtxt('../src/silicon/etot-vs-kpoint.dat', delimiter=' ', unpack=True)\nplt.plot(x, y, \"o-\", markersize=5, label='Etot vs kpoints')\nplt.xlabel('# kpoints')\nplt.ylabel('Etot (Ry)')\nplt.legend(frameon=False)\nplt.show()\n"})}),"\n",(0,i.jsx)("img",{src:t(6524).Z,class:"inv-hue-rot-180",alt:"etot-vs-kpoints"}),"\n",(0,i.jsx)(n.h2,{id:"convergence-against-lattice-constant",children:"Convergence against lattice constant"}),"\n",(0,i.jsx)(n.p,{children:"Calculating total energy with respect to varying lattice constant."}),"\n","\n",(0,i.jsx)(a.Z,{language:"bash",title:"src/silicon/si_scf_alat.pwtk",showLineNumbers:!0,children:'load_fromPWI pw.scf.silicon.in\n\n# please uncomment & insert value as determined in the "ecutwfc" exercise\nSYSTEM { ecutwfc = 30 }\n\n# please uncomment & insert values as determined in the "kpoints" exercise\nK_POINTS automatic { 6 6 6 1 1 1 }\n\n\nset fid [open etot-vs-alat.dat w]\n\nforeach alat { 9.7 9.8 9.9 10.0 10.1 10.2 10.3 10.4 10.5 10.6 10.7 } {\n\n    set name si_scf_alat-$alat\n\n    SYSTEM "celldm(1) = $alat"\n    runPW $name.in\n\n    set Etot [::pwtk::pwo::totene $name.out]\n    puts $fid "$alat $Etot"\n}\n\nclose $fid\n'}),"\n",(0,i.jsx)(n.p,{children:"Run the above code:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"pwtk si_scf_alat.pwtk\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",metastring:'title="notebooks/silicon-scf.ipynb" showLineNumbers',children:"x, y = np.loadtxt('../src/silicon/etot-vs-alat.dat', delimiter=' ', unpack=True)\nplt.plot(x, y, \"o-\", markersize=5, label='Etot vs alat')\nplt.xlabel('alat (Bohr)')\nplt.ylabel('Etot (Ry)')\nplt.legend(frameon=False)\nplt.show()\n"})}),"\n",(0,i.jsx)("img",{src:t(4336).Z,class:"inv-hue-rot-180",alt:"etot-vs-alat"}),"\n",(0,i.jsx)(n.h2,{id:"note-on-cpu-time",children:"Note on CPU time"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["CPU time is proportional to the number of plane waves used for the\ncalculation. Number of plane wave is proportional to the (ecutwfc)",(0,i.jsx)("sup",{children:"3/2"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"CPU time is proportional to the number if inequivalent k-points"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["CPU time increases as N",(0,i.jsx)("sup",{children:"3"}),", where N is the number of atoms in the\nsystem."]}),"\n"]}),"\n"]})]})}function u(e={}){let{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},4336:function(e,n,t){t.d(n,{Z:()=>s});let s=t.p+"assets/images/etot-vs-alat-5491930b9380c877f6f3ee7e8630d735.webp"},739:function(e,n,t){t.d(n,{Z:()=>s});let s=t.p+"assets/images/etot-vs-ecutwfc-952592f51ad4594a8e4f0caf8050c5b2.webp"},6524:function(e,n,t){t.d(n,{Z:()=>s});let s=t.p+"assets/images/etot-vs-kpoints-f63a8b6dc81ea6f91e4cabbc02686315.webp"}}]);